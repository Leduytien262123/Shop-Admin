import{_ as M}from"./CommonPage-r69Mp4tc.js";import{u as Z,R as D,J as H,c as m,w as K,af as F,d as G,o as J,e as t,j as n,ao as Q,au as W,av as X,aj as Y,at as ee,a8 as ne,aw as ae,l as k,W as te,E as le,h as b,t as re,ah as ue,Z as v}from"./index-DYcU_f0W.js";const oe={class:"flex items-center justify-center"},pe=Object.assign({name:"OrderAddEdit"},{__name:"OrderAddEdit",props:{id:{type:[String,Number],default:null}},setup(N){const _=N,E=Z(),h=D(),p=H(()=>!!_.id),y=m([]),d=m(!1),x=m([]),a=m({creator_id:h.userId,creator_name:h.username,customer_name:"",phone:"",email:"",address:"",note:"",coupon_code:null,shipping_fee:null,status:"new",payment_method:"unpaid",order_type:"retail"}),C=[{label:"Đơn hàng mới",value:"new"},{label:"Đang xử lý",value:"processing"},{label:"Hoàn thành",value:"completed"},{label:"Hủy",value:"canceled"}],S=[{label:"Chưa thanh toán",value:"unpaid"},{label:"Đã thanh toán",value:"paid"}],U=[{label:"Đơn khách lẻ",value:"retail"},{label:"Đơn web",value:"web",disabled:!p.value}],B={creator_name:[{required:!0,message:"Không xác định người tạo",trigger:["blur","input"]}],customer_name:[{required:!0,trigger:["blur","input"],validator(l,e){const u=String(e||"").trim();return u?u.length<2?new Error("Tên khách hàng phải có ít nhất 2 ký tự"):u.length>100?new Error("Tên khách hàng không được quá 100 ký tự"):!0:new Error("Vui lòng nhập tên khách hàng")},trigger:["blur","input"]}],phone:[{required:!0,trigger:["blur","input"],validator(l,e){const u=String(e||"").trim();if(!u)return new Error("Vui lòng nhập số điện thoại");const i=["032","033","034","035","036","037","038","039","070","076","077","078","079","081","082","083","084","085","086","056","058","059","090","093","089","092","094","099","098","097","096","091","095"];if(!/^0\d{9}$/.test(u))return new Error("Số điện thoại định dạng không chính xác (phải gồm 10 số và bắt đầu bằng 0)");const o=u.substring(0,3);return i.includes(o)?!0:new Error("Số điện thoại định dạng không chính xác (đầu số không hợp lệ)")}}],email:[{required:!0,trigger:["blur","input"],validator(l,e){const u=String(e||"").trim();return u?/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(u)?!0:new Error("Email không đúng định dạng"):new Error("Vui lòng nhập email")}}],address:[{required:!0,trigger:["blur","input"],validator(l,e){const u=String(e||"").trim();return u?u.length<10?new Error("Địa chỉ phải có ít nhất 10 ký tự"):u.length>255?new Error("Địa chỉ không được quá 255 ký tự"):!0:new Error("Vui lòng nhập địa chỉ")},trigger:["blur","input"]}]};function $(l){return l.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim("-")}K(()=>a.value.name,l=>{l&&(a.value.slug=$(l))});const w=m(null);async function T(){var l,e;try{d.value=!0;const u={page:1,length:10},i=await v.getProducts(u);y.value=((e=(l=i.data)==null?void 0:l.data)==null?void 0:e.products.map(o=>({label:o.name,value:o.id})))||[]}catch{$message.error("Không thể tải danh sách đơn hàng")}finally{d.value=!1}}async function V(){if(_.id)try{d.value=!0;const l=await v.getOrderById(_.id);if(l.data.success){const e=l.data.data;a.value={creator_id:e.creator_id,creator_name:e.creator_name,customer_name:e.customer_name||"",phone:e.phone||"",email:e.email||"",address:e.address||"",note:e.note||"",coupon_code:e.coupon_code||"",shipping_fee:e.shipping_fee||null,status:e.status||null,payment_method:e.payment_method||null,order_type:e.order_type||null}}}catch(l){$message.error("Không thể tải thông tin đơn hàng"),console.error("Load order error:",l)}finally{d.value=!1}}F(()=>{p.value||(a.value.creator_id=h.userId,a.value.creator_name=h.username),T(),p.value&&V()});function f(){E.push("/order")}async function q(){var l;try{await((l=w.value)==null?void 0:l.validate()),d.value=!0;const e={...a.value,creator_id:h.userId};p.value?(await v.updateOrder(_.id,e),$message.success("Cập nhật đơn hàng thành công!")):(await v.createOrder(e),$message.success("Thêm đơn hàng thành công!")),f()}catch(e){if(e!=null&&e.errors)return;const u=p.value?"Cập nhật đơn hàng thất bại":"Thêm đơn hàng thất bại";$message.error(u),console.error("Save order error:",e)}finally{d.value=!1}}const I=l=>{const e=l.replace(/[^\d.]/g,"").trim();return/^\d+(\.(\d+)?)?$/.test(e)?Number(e):e===""?null:Number.NaN},O=l=>l==null||isNaN(l)?"":l.toLocaleString("vi-VN",{style:"currency",currency:"VND"});function g(){a.value.customer_name&&(a.value.customer_name=a.value.customer_name.trim().replace(/\s+/g," ")),a.value.address&&(a.value.address=a.value.address.trim().replace(/\s+/g," ")),a.value.note&&(a.value.note=a.value.note.trim().replace(/\s+/g," "))}return(l,e)=>{const u=le,i=ee,o=Y,s=X,c=ne,R=ae,z=W,A=Q,L=te,P=ue,j=M;return J(),G(j,null,{action:t(()=>[n(u,{onClick:f},{default:t(()=>e[14]||(e[14]=[k("i",{class:"i-material-symbols:arrow-back mr-4 text-18"},null,-1),b(" Quay lại ")])),_:1,__:[14]})]),default:t(()=>[n(P,{title:p.value?"Sửa đơn hàng":"Thêm đơn hàng"},{action:t(()=>[k("div",oe,[n(L,null,{default:t(()=>[n(u,{onClick:f},{default:t(()=>e[15]||(e[15]=[b("Hủy")])),_:1,__:[15]}),n(u,{type:"primary",onClick:q},{default:t(()=>[b(re(p.value?"Cập nhật":"Lưu"),1)]),_:1})]),_:1})])]),default:t(()=>[n(A,{model:a.value,rules:B,ref_key:"formRef",ref:w},{default:t(()=>[n(z,{cols:"3","x-gap":"12","y-gap":"12"},{default:t(()=>[n(s,{span:"1"},{default:t(()=>[n(o,{label:"Trạng thái",path:"status"},{default:t(()=>[n(i,{value:a.value.status,"onUpdate:value":e[0]||(e[0]=r=>a.value.status=r),options:C,disabled:!p.value,placeholder:"Chọn trạng thái"},null,8,["value","disabled"])]),_:1})]),_:1}),n(s,{span:"1"},{default:t(()=>[n(o,{label:"Thanh toán",path:"payment_method"},{default:t(()=>[n(i,{value:a.value.payment_method,"onUpdate:value":e[1]||(e[1]=r=>a.value.payment_method=r),options:S,placeholder:"Chọn thanh toán"},null,8,["value"])]),_:1})]),_:1}),n(s,{span:"1"},{default:t(()=>[n(o,{label:"Loại đơn",path:"order_type"},{default:t(()=>[n(i,{value:a.value.order_type,"onUpdate:value":e[2]||(e[2]=r=>a.value.order_type=r),options:U,disabled:p.value,placeholder:"Chọn loại đơn"},null,8,["value","disabled"])]),_:1})]),_:1}),n(s,{span:"1"},{default:t(()=>[n(o,{label:"Người tạo",path:"creator_name"},{default:t(()=>[n(c,{value:a.value.creator_name,"onUpdate:value":e[3]||(e[3]=r=>a.value.creator_name=r),onBlur:g,placeholder:"Nhập tên người tạo",readonly:""},null,8,["value"])]),_:1})]),_:1}),n(s,{span:"1"},{default:t(()=>[n(o,{label:"Tên khách hàng",path:"customer_name"},{default:t(()=>[n(c,{value:a.value.customer_name,"onUpdate:value":e[4]||(e[4]=r=>a.value.customer_name=r),onBlur:g,placeholder:"Nhập tên khách hàng"},null,8,["value"])]),_:1})]),_:1}),n(s,{span:"1"},{default:t(()=>[n(o,{label:"Số điện thoại",path:"phone"},{default:t(()=>[n(c,{value:a.value.phone,"onUpdate:value":e[5]||(e[5]=r=>a.value.phone=r),onInput:e[6]||(e[6]=r=>a.value.phone=r.replace(/[^\d]/g,"").slice(0,10)),"input-props":{inputmode:"numeric",pattern:"[0-9]*",maxlength:10},placeholder:"Nhập số điện thoại"},null,8,["value"])]),_:1})]),_:1}),n(s,{span:"1"},{default:t(()=>[n(o,{label:"Email",path:"email"},{default:t(()=>[n(c,{value:a.value.email,"onUpdate:value":e[7]||(e[7]=r=>a.value.email=r),onInput:e[8]||(e[8]=r=>a.value.email=r.replace(/[^\d]/g,"")),placeholder:"Nhập email"},null,8,["value"])]),_:1})]),_:1}),n(s,{span:"2"},{default:t(()=>[n(o,{label:"Địa chỉ",path:"address"},{default:t(()=>[n(c,{value:a.value.address,"onUpdate:value":e[9]||(e[9]=r=>a.value.address=r),onBlur:g,placeholder:"Nhập địa chỉ"},null,8,["value"])]),_:1})]),_:1}),n(s,{span:"2"},{default:t(()=>[n(o,{label:"Ghi chú",path:"note"},{default:t(()=>[n(c,{value:a.value.note,"onUpdate:value":e[10]||(e[10]=r=>a.value.note=r),onBlur:g,placeholder:"Ghi chú"},null,8,["value"])]),_:1})]),_:1}),n(s,{span:"1"}),n(s,{span:"1"},{default:t(()=>[n(o,{label:"Mã giảm giá",path:"coupon_code"},{default:t(()=>[n(i,{value:a.value.coupon_code,"onUpdate:value":e[11]||(e[11]=r=>a.value.coupon_code=r),options:x.value,filterable:"",placeholder:"Chọn mã giảm giá",clearable:""},null,8,["value","options"])]),_:1})]),_:1}),n(s,{span:"1"},{default:t(()=>[n(o,{label:"Phí ship",path:"shipping_fee"},{default:t(()=>[n(R,{value:a.value.shipping_fee,"onUpdate:value":e[12]||(e[12]=r=>a.value.shipping_fee=r),parse:I,format:O,"show-button":!1,placeholder:"Nhập phí ship",class:"w-full"},null,8,["value"])]),_:1})]),_:1}),n(s,{span:"2"},{default:t(()=>[n(o,{label:"Chọn sản phẩm",path:"category_id"},{default:t(()=>[n(i,{value:a.value.category_id,"onUpdate:value":e[13]||(e[13]=r=>a.value.category_id=r),options:y.value,filterable:"",placeholder:"Chọn sản phẩm"},null,8,["value","options"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1})}}});export{pe as _};
